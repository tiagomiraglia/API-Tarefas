model AvisoVisualizacao {
  id            Int      @id @default(autoincrement())
  aviso_id      Int
  usuario_id    Int
  visualizado_em DateTime @default(now())
  aviso         Aviso   @relation(fields: [aviso_id], references: [id])
  usuario       Usuario @relation(fields: [usuario_id], references: [id])
  @@unique([aviso_id, usuario_id])
}
model PermissaoKanban {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  aba_id     Int
  coluna_id  Int?
  tipo       String   // visualizar | mover | editar | admin
  usuario    Usuario  @relation("PermissaoUsuario", fields: [usuario_id], references: [id])
  aba        Aba      @relation("PermissaoAba", fields: [aba_id], references: [id])
  coluna     Coluna?  @relation("PermissaoColuna", fields: [coluna_id], references: [id])
  created_at DateTime @default(now())
}

model Aba {
  id         Int      @id @default(autoincrement())
  nome       String
  empresa_id Int
  empresa    Empresa  @relation(fields: [empresa_id], references: [id])
  ordem      Int      @default(0)
  colunas    Coluna[]
  created_at DateTime @default(now())
  permissoes_kanban        PermissaoKanban[] @relation("PermissaoAba")
}

model Coluna {
  id           Int      @id @default(autoincrement())
  nome         String
  ordem        Int      @default(0)
  aba_id       Int
  aba          Aba      @relation(fields: [aba_id], references: [id])
  recebe_whats Boolean  @default(false)
  created_at   DateTime @default(now())
  permissoes_kanban        PermissaoKanban[] @relation("PermissaoColuna")
  cartoes      Cartao[]
}

model Cartao {
  id                       Int      @id @default(autoincrement())
  titulo                   String
  descricao                String?  @db.Text
  coluna_id                Int
  coluna                   Coluna   @relation(fields: [coluna_id], references: [id], onDelete: Cascade)
  usuario_atribuido_id     Int?
  usuario_atribuido        Usuario? @relation("CartaoAtribuido", fields: [usuario_atribuido_id], references: [id])
  atendente_responsavel_id Int?
  atendente_responsavel    Usuario? @relation("CartaoAtendente", fields: [atendente_responsavel_id], references: [id])
  ordem                    Int      @default(0)
  data_vencimento          DateTime?
  etiquetas                Json?    @default("[]")
  checklist                Json?    @default("[]")
  cor                      String?  @default("#ffffff")
  status_atendimento       String?  // novo, em_atendimento, aguardando_cliente, resolvido, etc
  valor_orcamento          Decimal? @db.Decimal(10, 2)
  anotacoes                String?  @db.Text
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt
  created_by_id            Int?
  created_by               Usuario? @relation("CartaoCriador", fields: [created_by_id], references: [id])
  whatsapp                 CartaoWhatsApp?
  historico                CartaoHistorico[]
  anexos                   CartaoAnexo[]
  transferencias           CartaoTransferencia[]
}

model CartaoWhatsApp {
  id              Int      @id @default(autoincrement())
  cartao_id       Int      @unique
  cartao          Cartao   @relation(fields: [cartao_id], references: [id], onDelete: Cascade)
  conversa_id     String   // ID da conversa do WhatsApp (número do contato ou grupo)
  conversa_nome   String?  // Nome do contato ou grupo
  mensagens       MensagemWhatsApp[]
  created_at      DateTime @default(now())
}

model MensagemWhatsApp {
  id                    Int      @id @default(autoincrement())
  cartao_whatsapp_id    Int
  cartao_whatsapp       CartaoWhatsApp @relation(fields: [cartao_whatsapp_id], references: [id], onDelete: Cascade)
  mensagem_id           String   // ID único da mensagem do WhatsApp
  autor                 String   // Número ou nome de quem enviou
  conteudo              String?  @db.Text
  tipo                  String   @default("text") // text, image, video, audio, document
  midia_url             String?
  status                String?  @default("sent") // sent, delivered, read, failed
  is_from_me            Boolean  @default(false)
  timestamp             DateTime
  created_at            DateTime @default(now())
  @@unique([cartao_whatsapp_id, mensagem_id])
}

model CartaoHistorico {
  id          Int      @id @default(autoincrement())
  cartao_id   Int
  cartao      Cartao   @relation(fields: [cartao_id], references: [id], onDelete: Cascade)
  usuario_id  Int
  usuario     Usuario  @relation("CartaoHistorico", fields: [usuario_id], references: [id])
  acao        String   // "criou", "moveu", "editou", "atribuiu", "comentou"
  descricao   String?  @db.Text
  de_coluna_id Int?
  para_coluna_id Int?
  created_at  DateTime @default(now())
}

model CartaoAnexo {
  id          Int      @id @default(autoincrement())
  cartao_id   Int
  cartao      Cartao   @relation(fields: [cartao_id], references: [id], onDelete: Cascade)
  nome        String
  url         String
  tipo        String?  // image, document, etc
  tamanho     Int?
  created_at  DateTime @default(now())
  uploaded_by_id Int?
  uploaded_by Usuario? @relation("CartaoAnexo", fields: [uploaded_by_id], references: [id])
}

model CartaoTransferencia {
  id                     Int      @id @default(autoincrement())
  cartao_id              Int
  cartao                 Cartao   @relation(fields: [cartao_id], references: [id], onDelete: Cascade)
  usuario_origem_id      Int
  usuario_origem         Usuario  @relation("TransferenciaUsuarioOrigem", fields: [usuario_origem_id], references: [id])
  usuario_destino_id     Int
  usuario_destino        Usuario  @relation("TransferenciaUsuarioDestino", fields: [usuario_destino_id], references: [id])
  observacao             String?  @db.Text
  coluna_origem_id       Int?
  coluna_destino_id      Int?
  created_at             DateTime @default(now())
  
  @@index([cartao_id])
  @@index([usuario_origem_id])
  @@index([usuario_destino_id])
  @@index([created_at])
}

model Aviso {
  id                Int      @id @default(autoincrement())
  mensagem          String
  ativo             Boolean  @default(false)
  data_criacao      DateTime @default(now())
  data_expiracao    DateTime?
  destinatario_id   Int?     // usuário específico
  destinatario_nivel String? // grupo: 'admin', 'usuario', etc
  visualizacoes     AvisoVisualizacao[]
  destinatario      Usuario? @relation("AvisosDestinatario", fields: [destinatario_id], references: [id])
}

model codigos_verificacao {
  id             Int      @id @default(autoincrement())
  email          String
  codigo         String   @db.VarChar(10)
  data_expiracao DateTime
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Empresa {
  id          Int      @id @default(autoincrement())
  nome        String
  cnpj        String?  @unique
  created_at  DateTime @default(now())
  status      String   @default("ativo")
  config_kanban Json   @default("{\"usar_orcamento\": false, \"usar_status_visual\": true, \"tags_personalizadas\": false}")
  usuarios    Usuario[]
  abas        Aba[]
  tags        Tag[]
  whatsapp_sessions WhatsAppSession[]
}

model Usuario {
  id                        Int      @id @default(autoincrement())
  nome                      String
  email                     String   @unique
  senha                     String?
  empresa_id                Int
  empresa                   Empresa  @relation(fields: [empresa_id], references: [id])
  permissoes                Json     @default("{}")
  convite_token             String?
  convite_expira_em         DateTime?
  suspenso                  Boolean  @default(false)
  is_superuser              Boolean  @default(false)
  nivel                     String?  @default("usuario")
  foto                      String?
  created_at                DateTime @default(now())
  ultimo_login              DateTime? @db.Timestamptz
  temp_password             String?
  temp_password_expires_at  DateTime?
  needs_password_reset      Boolean  @default(false)
  permissoes_kanban        PermissaoKanban[] @relation("PermissaoUsuario")
  avisos_visualizados      AvisoVisualizacao[]
  avisos_destinados        Aviso[] @relation("AvisosDestinatario")
  cartoes_atribuidos       Cartao[] @relation("CartaoAtribuido")
  cartoes_criados          Cartao[] @relation("CartaoCriador")
  cartoes_atendente        Cartao[] @relation("CartaoAtendente")
  cartoes_historico        CartaoHistorico[] @relation("CartaoHistorico")
  anexos_uploaded          CartaoAnexo[] @relation("CartaoAnexo")
  transferencias_enviadas  CartaoTransferencia[] @relation("TransferenciaUsuarioOrigem")
  transferencias_recebidas CartaoTransferencia[] @relation("TransferenciaUsuarioDestino")
}

model Tag {
  id         Int      @id @default(autoincrement())
  empresa_id Int
  empresa    Empresa  @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nome       String
  cor        String   @default("#6366f1")
  icone      String   @default("tag")
  ativo      Boolean  @default(true)
  ordem      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([empresa_id, ativo])
}

model WhatsAppSession {
  id                Int      @id @default(autoincrement())
  session_id        String   @unique // ID único da sessão (empresa_X_telefone)
  empresa_id        Int
  empresa           Empresa  @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  telefone          String?  // Número do WhatsApp conectado
  status            String   @default("disconnected") // connecting, connected, disconnected, qr
  qr_code           String?  // QR Code em base64 quando disponível
  auth_data         Json?    // Dados de autenticação criptografados
  retry_count       Int      @default(0)
  last_activity     DateTime @default(now())
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  connected_at      DateTime?
  disconnected_at   DateTime?

  @@index([empresa_id])
  @@index([status])
  @@index([last_activity])
}
